# Sprint 3 Phase 4 - State Sub-package Attempt

**Date:** 2026-01-30  
**Objective:** Move state files to `internal/app/state/` sub-package  
**Result:** Skipped due to circular dependencies

## Issue Found

The state files (`*_state.go`) reference types defined in the main app package:
- `AppMode` enum (defined in `modes.go`)
- `SetupWizardStep` enum (defined in `setup_wizard.go`)
- `ConfirmationType` (defined in `confirm_dialog.go`)

This creates a circular dependency:

```
app.go → imports state package → state files need AppMode, SetupWizardStep, etc. → imports app package
```

## Why This Happens

1. State files like `workflow_state.go` use `AppMode` in their constructors:
   ```go
   PreviousMode: ModeMenu,  // AppMode enum from modes.go
   ```

2. State files like `environment_state.go` use `SetupWizardStep`:
   ```go
   SetupWizardStep: SetupStepWelcome,  // From setup_wizard.go
   ```

3. Moving them to a separate package would require importing the app package, creating a cycle.

## Options Considered

### Option 1: Keep state files in main package (Chosen)
State files remain in `internal/app/` to avoid circular dependencies.
- **Pros:** No import cycles, simple structure
- **Cons:** Not as clean organizationally

### Option 2: Move types to state package
Move `AppMode`, `SetupWizardStep`, etc. to the state package.
- **Pros:** Clean separation
- **Cons:** Massive refactoring, changes many files

### Option 3: Use interfaces
Define minimal interfaces in state package that app package implements.
- **Pros:** Clean separation
- **Cons:** Complex, changes many files

## Decision

**Skipped Phase 4.** The codebase is small enough that the complexity of creating a state sub-package outweighs the benefits. State files remain in `internal/app/` alongside the main application code.

## Sprint 3 Final Status

| Phase | Description | Status | Lines Reduced |
|-------|-------------|--------|---------------|
| 1 | Extract Bubble Tea Methods | ✅ Complete | 1,770 → 1,052 (40.6%) |
| 2 | Inline Delegation Methods | ✅ Complete | 1,052 → 974 (7.4%) |
| 3 | Split Confirmation Handlers | ✅ Complete | 1,052 → 974 → 1,011 (4.1%) |
| 4 | Create State Sub-package | ⏭️ Skipped | N/A (circular deps) |

**Total Reduction:** 1,770 → 1,011 lines (42.9% overall)

## Files After Sprint 3

```
internal/app/
├── app.go                    (974 lines) - Core Application struct
├── app_init.go               (135 lines) - Init + RestoreFromTimeTravel
├── app_update.go            (326 lines) - Update + handlers
├── app_view.go              (301 lines) - View + rendering helpers
├── confirm_dialog.go        (362 lines) - Dialog infrastructure
├── confirm_handlers.go      (649 lines) - Confirmation handlers
├── *_state.go               (11 files) - State management (769 total lines)
└── ... (other files)
```

## Verification

```bash
cd /Users/jreng/Documents/Poems/dev/tit
./build.sh
# ✓ Built successfully
```

## Recommendation

For a cleaner architecture without circular dependencies, consider:
- Moving state files to `internal/state/` (separate from `internal/app/`)
- Having state package own all state-related types (`AppMode`, etc.)
- This would be a larger refactoring beyond Sprint 3 scope

For now, the current organization is functional and buildable.

---

*Generated by ENGINEER role*
